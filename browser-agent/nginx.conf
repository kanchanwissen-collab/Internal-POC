worker_processes auto;worker_processes auto;

events { events { 

  worker_connections 2048;  worker_connections 2048;

  use epoll;  use epoll;

  multi_accept on;  multi_accept on;

}}

  

http {http {

  include       mime.types;  include       mime.types;

  default_type  application/octet-stream;  default_type  application/octet-stream;

  sendfile on;  sendfile on;

  tcp_nopush on;  tcp_nopush on;

  tcp_nodelay on;  tcp_nodelay on;

  keepalive_timeout 75;  keepalive_timeout 75;

  keepalive_requests 1000;  keepalive_requests 1000;

  

  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '

                    '$status $body_bytes_sent "$http_referer" '                    '$status $body_bytes_sent "$http_referer" '

                    '"$http_user_agent" "$http_x_forwarded_for"';                    '"$http_user_agent" "$http_x_forwarded_for"';

  access_log  /dev/stdout main;  access_log  /dev/stdout main;

  error_log   /dev/stderr info;  error_log   /dev/stderr info;

  

  server {  server {

    # Cloud Run sets $PORT automatically    # Cloud Run sets $PORT automatically

    listen 8080;    listen 8080;

    server_name _;    server_name _;

  

    # Root health check for Cloud Run    # Root health check for Cloud Run

    location = / {    location = / {

      proxy_pass http://127.0.0.1:8000/api/health;      proxy_pass http://127.0.0.1:8000/api/health;

      proxy_http_version 1.1;      proxy_http_version 1.1;

      proxy_set_header Host $host;      proxy_set_header Host $host;

    }    }

  

    # FastAPI APIs with versioning - No rate limiting    

    location /api/ { 

      proxy_pass http://127.0.0.1:8000;    # FastAPI APIs with versioning - No rate limiting

      proxy_http_version 1.1;    location /api/ {

      proxy_set_header Host $host;      proxy_pass http://127.0.0.1:8000;

      proxy_set_header X-Real-IP $remote_addr;      proxy_http_version 1.1;

      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;      proxy_set_header Host $host;

      proxy_set_header X-Forwarded-Proto $scheme;      proxy_set_header X-Real-IP $remote_addr;

      proxy_set_header Upgrade $http_upgrade;      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_set_header Connection "upgrade";      proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;

      # Increase timeouts for long-running agent tasks      proxy_set_header Connection "upgrade";

      proxy_read_timeout 3600s;      

      proxy_send_timeout 3600s;      # Increase timeouts for long-running agent tasks

      proxy_connect_timeout 60s;      proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

      # Buffer settings to handle large responses      proxy_connect_timeout 60s;

      proxy_buffering off;      

      proxy_request_buffering off;      # Buffer settings to handle large responses

    }      proxy_buffering off;

       proxy_request_buffering off;

    # VNC WebSocket connections for sessions session_00 to session_09    }

    location /sessions/session_00/vnc/ { 

        proxy_pass http://127.0.0.1:5080/;    # VNC WebSocket connections for sessions session_00 to session_09

        proxy_http_version 1.1;    location /sessions/session_00/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5080/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_01/vnc/ {    }

        proxy_pass http://127.0.0.1:5081/;    

        proxy_http_version 1.1;    location /sessions/session_01/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5081/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_02/vnc/ {    }

        proxy_pass http://127.0.0.1:5082/;    

        proxy_http_version 1.1;    location /sessions/session_02/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5082/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_03/vnc/ {    }

        proxy_pass http://127.0.0.1:5083/;    

        proxy_http_version 1.1;    location /sessions/session_03/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5083/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_04/vnc/ {    }

        proxy_pass http://127.0.0.1:5084/;    

        proxy_http_version 1.1;    location /sessions/session_04/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5084/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_05/vnc/ {    }

        proxy_pass http://127.0.0.1:5085/;    

        proxy_http_version 1.1;    location /sessions/session_05/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5085/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_06/vnc/ {    }

        proxy_pass http://127.0.0.1:5086/;    

        proxy_http_version 1.1;    location /sessions/session_06/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5086/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_07/vnc/ {    }

        proxy_pass http://127.0.0.1:5087/;    

        proxy_http_version 1.1;    location /sessions/session_07/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5087/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_08/vnc/ {    }

        proxy_pass http://127.0.0.1:5088/;    

        proxy_http_version 1.1;    location /sessions/session_08/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5088/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

            proxy_send_timeout 3600s;

    location /sessions/session_09/vnc/ {    }

        proxy_pass http://127.0.0.1:5089/;    

        proxy_http_version 1.1;    location /sessions/session_09/vnc/ {

        proxy_set_header Upgrade $http_upgrade;        proxy_pass http://127.0.0.1:5089/;

        proxy_set_header Connection "upgrade";        proxy_http_version 1.1;

        proxy_set_header Host $host;        proxy_set_header Upgrade $http_upgrade;

        proxy_read_timeout 3600s;        proxy_set_header Connection "upgrade";

        proxy_send_timeout 3600s;        proxy_set_header Host $host;

    }        proxy_read_timeout 3600s;

  }        proxy_send_timeout 3600s;

}    }
  }
